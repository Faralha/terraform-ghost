{
  "name": "Terraform Drift - Advanced Monitoring",
  "nodes": [
    {
      "parameters": {
        "path": "drift-detected",
        "options": {}
      },
      "id": "advanced-drift-webhook",
      "name": "Drift Detected",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "path": "drift-status",
        "options": {}
      },
      "id": "advanced-status-webhook",
      "name": "Status Update",
      "type": "n8n-nodes-base.webhook", 
      "typeVersion": 1,
      "position": [240, 500]
    },
    {
      "parameters": {
        "path": "drift-error",
        "options": {}
      },
      "id": "advanced-error-webhook",
      "name": "Error Alert",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 700]
    },
    {
      "parameters": {
        "jsCode": "// Enhanced data processing for drift events\nconst eventData = $input.first().json;\nconst timestamp = new Date().toISOString();\n\n// Parse terraform plan output for detailed analysis\nlet changeDetails = {\n  resources_to_add: 0,\n  resources_to_change: 0,\n  resources_to_destroy: 0,\n  total_changes: 0\n};\n\n// Extract numbers from summary if available\nif (eventData.summary) {\n  const addMatch = eventData.summary.match(/(\\d+) to add/);\n  const changeMatch = eventData.summary.match(/(\\d+) to change/);\n  const destroyMatch = eventData.summary.match(/(\\d+) to destroy/);\n  \n  if (addMatch) changeDetails.resources_to_add = parseInt(addMatch[1]);\n  if (changeMatch) changeDetails.resources_to_change = parseInt(changeMatch[1]);\n  if (destroyMatch) changeDetails.resources_to_destroy = parseInt(destroyMatch[1]);\n  \n  changeDetails.total_changes = changeDetails.resources_to_add + \n                               changeDetails.resources_to_change + \n                               changeDetails.resources_to_destroy;\n}\n\n// Determine severity level\nlet severity;\nif (eventData.event === 'drift_detected') {\n  if (changeDetails.resources_to_destroy > 0) {\n    severity = 'CRITICAL';\n  } else if (changeDetails.total_changes > 5) {\n    severity = 'HIGH';\n  } else {\n    severity = 'MEDIUM';\n  }\n} else if (eventData.event === 'no_drift') {\n  severity = 'INFO';\n} else {\n  severity = 'CRITICAL';\n}\n\n// Create enriched payload\nconst enrichedData = {\n  ...eventData,\n  processed_at: timestamp,\n  severity: severity,\n  change_details: changeDetails,\n  project_info: {\n    name: 'terraform-ghost',\n    environment: 'production',\n    repository: 'https://github.com/Faralha/terraform-ghost'\n  },\n  monitoring: {\n    source_system: 'terraform_drift_detection',\n    version: '1.0.0',\n    check_interval: '5_minutes'\n  }\n};\n\nreturn { json: enrichedData };"
      },
      "id": "enrich-event-data",
      "name": "Enrich Event Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 500]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "severity-critical",
              "leftValue": "={{ $json.severity }}",
              "rightValue": "CRITICAL",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-severity",
      "name": "Is Critical?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.pagerduty.com/incidents",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Token token=YOUR_PAGERDUTY_API_TOKEN"
            },
            {
              "name": "Content-Type", 
              "value": "application/json"
            },
            {
              "name": "Accept",
              "value": "application/vnd.pagerduty+json;version=2"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"incident\": {\n    \"type\": \"incident\",\n    \"title\": \"Terraform Drift Detected - {{ $json.project_info.name }}\",\n    \"service\": {\n      \"id\": \"YOUR_PAGERDUTY_SERVICE_ID\",\n      \"type\": \"service_reference\"\n    },\n    \"urgency\": \"high\",\n    \"body\": {\n      \"type\": \"incident_body\",\n      \"details\": \"Terraform configuration drift detected.\\n\\nSeverity: {{ $json.severity }}\\nHost: {{ $json.hostname }}\\nChanges: {{ $json.change_details.total_changes }}\\nSummary: {{ $json.summary }}\"\n    }\n  }\n}",
        "options": {}
      },
      "id": "create-pagerduty-incident",
      "name": "Create PagerDuty Incident",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300],
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"channel\": \"#terraform-alerts\",\n  \"username\": \"Terraform Drift Monitor\",\n  \"icon_emoji\": \":warning:\",\n  \"attachments\": [\n    {\n      \"color\": \"{{ $json.severity === 'CRITICAL' ? 'danger' : ($json.severity === 'HIGH' ? 'warning' : 'good') }}\",\n      \"title\": \"{{ $json.event === 'drift_detected' ? 'ðŸš¨ Terraform Drift Detected' : ($json.event === 'no_drift' ? 'âœ… Terraform Status OK' : 'âŒ Terraform Error') }}\",\n      \"title_link\": \"{{ $json.project_info.repository }}\",\n      \"fields\": [\n        {\n          \"title\": \"Project\",\n          \"value\": \"{{ $json.project_info.name }}\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Severity\",\n          \"value\": \"{{ $json.severity }}\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Host\",\n          \"value\": \"{{ $json.hostname }}\",\n          \"short\": true\n        },\n        {\n          \"title\": \"Timestamp\",\n          \"value\": \"{{ $json.timestamp }}\",\n          \"short\": true\n        }\n        {{ $json.change_details.total_changes > 0 ? ',{\"title\": \"Resources to Add\",\"value\": \"' + $json.change_details.resources_to_add + '\",\"short\": true},{\"title\": \"Resources to Change\",\"value\": \"' + $json.change_details.resources_to_change + '\",\"short\": true},{\"title\": \"Resources to Destroy\",\"value\": \"' + $json.change_details.resources_to_destroy + '\",\"short\": true}' : '' }}\n      ],\n      \"footer\": \"Terraform Drift Detection System\",\n      \"ts\": \"{{ Math.floor(Date.now() / 1000) }}\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "send-slack-notification",
      "name": "Send Slack Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 500],
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8086/write?db=terraform_monitoring",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "raw",
        "body": "=terraform_drift,project={{ $json.project_info.name }},host={{ $json.hostname }},severity={{ $json.severity }} event=\"{{ $json.event }}\",exit_code={{ $json.exit_code }},resources_to_add={{ $json.change_details.resources_to_add }},resources_to_change={{ $json.change_details.resources_to_change }},resources_to_destroy={{ $json.change_details.resources_to_destroy }},total_changes={{ $json.change_details.total_changes }} {{ Math.floor(Date.now() * 1000000) }}",
        "options": {}
      },
      "id": "store-metrics-influxdb",
      "name": "Store Metrics (InfluxDB)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 700],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "log",
        "message": "=Advanced monitoring processed: {{ $json.event }} - Severity: {{ $json.severity }} - Changes: {{ $json.change_details.total_changes }}"
      },
      "id": "log-processed-event",
      "name": "Log Processed Event",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1120, 500]
    }
  ],
  "pinData": {},
  "connections": {
    "Drift Detected": {
      "main": [
        [
          {
            "node": "Enrich Event Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Update": {
      "main": [
        [
          {
            "node": "Enrich Event Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Alert": {
      "main": [
        [
          {
            "node": "Enrich Event Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enrich Event Data": {
      "main": [
        [
          {
            "node": "Is Critical?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Critical?": {
      "main": [
        [
          {
            "node": "Create PagerDuty Incident",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Slack Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Store Metrics (InfluxDB)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Slack Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Store Metrics (InfluxDB)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create PagerDuty Incident": {
      "main": [
        [
          {
            "node": "Log Processed Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Slack Notification": {
      "main": [
        [
          {
            "node": "Log Processed Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Metrics (InfluxDB)": {
      "main": [
        [
          {
            "node": "Log Processed Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4",
  "id": "4",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "tags": []
}