{
  "name": "Terraform Drift - Email Notifications",
  "nodes": [
    {
      "parameters": {
        "path": "drift-detected",
        "options": {}
      },
      "id": "email-webhook-drift",
      "name": "Drift Detected",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "path": "drift-status",
        "options": {}
      },
      "id": "email-webhook-status",
      "name": "Status Update",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        500
      ]
    },
    {
      "parameters": {
        "path": "drift-error",
        "options": {}
      },
      "id": "email-webhook-error",
      "name": "Error Alert",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        700
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "drift-condition",
              "leftValue": "={{ $json.event }}",
              "rightValue": "drift_detected",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-event-type",
      "name": "Is Drift Event?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        460,
        400
      ]
    },
    {
      "parameters": {
        "authentication": "generic",
        "generic": {
          "username": "your-email@gmail.com",
          "password": "your-app-password"
        },
        "fromEmail": "terraform-alerts@yourcompany.com",
        "toEmail": "devops-team@yourcompany.com",
        "subject": "üö® URGENT: Terraform Drift Detected - {{ $json.hostname }}",
        "emailFormat": "html",
        "message": "<!DOCTYPE html><html><head><style>body{font-family:Arial,sans-serif;margin:20px}.alert-box{background-color:#fff2f2;border:2px solid #ff6b6b;padding:20px;border-radius:8px;margin:20px 0}.header{color:#d63031;font-size:24px;font-weight:bold}.details{background-color:#f8f9fa;padding:15px;border-radius:5px;margin:10px 0}.action-required{background-color:#fdcb6e;padding:10px;border-radius:5px;margin:15px 0;font-weight:bold}</style></head><body><div class=\"alert-box\"><div class=\"header\">üö® Terraform Configuration Drift Detected</div><p><strong>Project:</strong> terraform-ghost</p><p><strong>Timestamp:</strong> {{ $json.timestamp }}</p><p><strong>Hostname:</strong> {{ $json.hostname }}</p><div class=\"details\"><h3>üìä Drift Summary:</h3><p>{{ $json.summary || $json.message }}</p><p><strong>Exit Code:</strong> {{ $json.exit_code }}</p><p><strong>Source:</strong> {{ $json.source }}</p></div><div class=\"action-required\">‚ö° <strong>IMMEDIATE ACTION REQUIRED</strong><br>Please review the terraform configuration and apply necessary changes to resolve the drift.</div><h3>üîß Next Steps:</h3><ol><li>SSH to the server: <code>ssh {{ $json.hostname }}</code></li><li>Navigate to project: <code>cd /path/to/terraform-ghost</code></li><li>Review changes: <code>terraform plan</code></li><li>Apply if needed: <code>terraform apply</code></li></ol><p><small>This alert was generated automatically by the Terraform Drift Detection System.</small></p></div></body></html>",
        "options": {
          "smtpHost": "smtp.gmail.com",
          "smtpPort": 587,
          "smtpSecurity": "starttls"
        }
      },\n      \"id\": \"send-drift-email\",\n      \"name\": \"Send Drift Alert Email\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"typeVersion\": 2,\n      \"position\": [\n        680,\n        300\n      ]\n    },\n    {\n      \"parameters\": {\n        \"authentication\": \"generic\",\n        \"generic\": {\n          \"username\": \"your-email@gmail.com\",\n          \"password\": \"your-app-password\"\n        },\n        \"fromEmail\": \"terraform-status@yourcompany.com\",\n        \"toEmail\": \"devops-team@yourcompany.com\",\n        \"subject\": \"{{ $json.event === 'no_drift' ? '‚úÖ Terraform Status: OK - ' + $json.hostname : '‚ùå Terraform Error - ' + $json.hostname }}\",\n        \"emailFormat\": \"html\",\n        \"message\": \"{{ $json.event === 'no_drift' ? \n          '<!DOCTYPE html><html><head><style>body{font-family:Arial,sans-serif;margin:20px}.ok-box{background-color:#f2fff2;border:2px solid#00b894;padding:20px;border-radius:8px;margin:20px 0}.header{color:#00b894;font-size:24px;font-weight:bold}.details{background-color:#f8f9fa;padding:15px;border-radius:5px;margin:10px 0}</style></head><body><div class=\"ok-box\"><div class=\"header\">‚úÖ Terraform Status: All Good</div><p><strong>Project:</strong> terraform-ghost</p><p><strong>Timestamp:</strong> ' + $json.timestamp + '</p><p><strong>Hostname:</strong> ' + $json.hostname + '</p><div class=\"details\"><h3>üìä Status:</h3><p>' + $json.message + '</p><p><strong>Source:</strong> ' + $json.source + '</p></div><p><small>No action required. Infrastructure matches configuration.</small></p></div></body></html>' : \n          '<!DOCTYPE html><html><head><style>body{font-family:Arial,sans-serif;margin:20px}.error-box{background-color:#fff2f2;border:2px solid#e17055;padding:20px;border-radius:8px;margin:20px 0}.header{color:#d63031;font-size:24px;font-weight:bold}.details{background-color:#f8f9fa;padding:15px;border-radius:5px;margin:10px 0}.urgent{background-color:#ff7675;color:white;padding:10px;border-radius:5px;margin:15px 0;font-weight:bold}</style></head><body><div class=\"error-box\"><div class=\"header\">‚ùå Terraform Error Occurred</div><p><strong>Project:</strong> terraform-ghost</p><p><strong>Timestamp:</strong> ' + $json.timestamp + '</p><p><strong>Hostname:</strong> ' + $json.hostname + '</p><div class=\"details\"><h3>üî¥ Error Details:</h3><p>' + $json.message + '</p><p><strong>Error Info:</strong> ' + ($json.error_details || 'Check server logs for details') + '</p><p><strong>Source:</strong> ' + $json.source + '</p></div><div class=\"urgent\">üö® CRITICAL: Terraform monitoring system encountered an error!</div><p><small>Please investigate immediately and ensure drift detection is working properly.</small></p></div></body></html>' \n        }}\",\n        \"options\": {\n          \"smtpHost\": \"smtp.gmail.com\",\n          \"smtpPort\": 587,\n          \"smtpSecurity\": \"starttls\"\n        }\n      },\n      \"id\": \"send-status-email\",\n      \"name\": \"Send Status/Error Email\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"typeVersion\": 2,\n      \"position\": [\n        680,\n        500\n      ]\n    },\n    {\n      \"parameters\": {\n        \"operation\": \"log\",\n        \"message\": \"=Email sent for Terraform event: {{ $json.event }} at {{ $json.timestamp }}\"\n      },\n      \"id\": \"log-email-sent\",\n      \"name\": \"Log Email Sent\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"typeVersion\": 1,\n      \"position\": [\n        900,\n        400\n      ]\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"Drift Detected\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Is Drift Event?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Status Update\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send Status/Error Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Error Alert\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send Status/Error Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Is Drift Event?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send Drift Alert Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Send Status/Error Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Send Drift Alert Email\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Log Email Sent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Send Status/Error Email\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Log Email Sent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"active\": false,\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"3\",\n  \"id\": \"3\",\n  \"meta\": {\n    \"templateCredsSetupCompleted\": true\n  },\n  \"tags\": []\n}